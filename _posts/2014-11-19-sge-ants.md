---
layout: post
title: "sge ants"
description: ""
category: 
tags: []
---
{% include JB/setup %}

# Ants on the Unacloud cluster using SGE

## Background

We got the challenge to generate an [Ants](https://github.com/stnava/ANTs) template from 211 images. We had runned ants in the past in a machine containing 32 cores and with 40 images the process took about 8 days. We approximated that in order to calculate this template in the same machine it would take abut a month of processing time. We would have to keep this machine all the time fully dedicated to this task. This was not possible as this machine is usually moved around the lab for different projects. Therefore we decided to try to run Ants in a cluster environment. 

Our university has a cluster platform called [unacloud](https://sistemas.uniandes.edu.co/~unacloud/dokuwiki/doku.php?id=inicio). It uses the computers in several computer rooms by running virtual machines in the background. These virtual machines are copied from an existing image and afterwards its name and ip address are changed. There are several tutorials around the web about installing sge, but here we will summarize the process that worked for us. For more information look at the [bibliography](#biblio) of this post.

We divide the process in the following steps:

1. A *nfs* shared file system, in order to share data and sge configuration.
2. A bind *dns server*, because sge relies a lot on host names.
3. SGE 
4. Ants 
5. Deploying in unacloud


## Test environment

In this example we are going to use a Fedora server, and Debian clients. The master server will be called cangurosge, and the execution nodes will be called canguros1, canguros2, canguros3 ... . We will assume all of them are inside a private network with prefix 10.0.2.

In all machines we have a user named `canguro`. The `/etc/hosts` file contains a line indicating the address of the master, for example


```bash
#/etc/hosts
127.0.0.1        localhost
10.0.2.5         cangurosge
```

In order to avoid problems, and because we assume we are in a trusted private network, we are going to turn off the firewall and selinux in the master. Notice in case you want to deploy this in a public netwowrk you should probably configure this services correctly

```bash
sudo systemctl stop firewalld
sudo systemctl disable firewalld
echo 0 > /sys/fs/selinux/enforce
```

```bash
#/etc/selinux/config
SELINUX=permissive
```

## NFS

### Server

We need to create a folder for , for example `/home/canguro/nfs` and add it to the exports file. The exports file should look like this

```bash
#/etc/exports
/home/canguro/nfs 10.0.2.1/24(rw,sync,no_all_squash,no_root_squash) 157.253.202.1/24(rw,sync,no_all_squash,no_root_squash)
/usr/share/gridengine/default 10.0.2.1/24(rw,sync,no_all_squash,no_root_squash) 157.253.202.238/24(rw,sync,no_all_squash,no_root_squash)
```

The second line is the folder where the sge configuration will be stored. Afterwards we need to start and enable the necessary services.

```bash
sudo systemctl enable rpcbind
sudo systemctl enable nfs-server
sudo service rpcbind start
sudo service nfs-server start
```

You can find more information about setting up the server at the [fedoraproject wiki][wiki_nfs].

### Client

In order to connect to the server from the client we first need to install the package _nfs-common_	

```bash
apt-get install nfs-common
```

Afterwards we create the directory `/home/canguro/nfs` and mount the remote file system by typing

```bash
mount -t nfs cangurosge:/home/canguro/nfs /home/canguro/nfs
```

You may test this by writing a test file in the master and looking at it in the client or the other way around. For more detailed information look for example at [this guide][debian_nfs]

<a name="biblio"></a>

## DNS Server

SGE is very picky about hostnames and ip addresses therefore it is very convenient to have a working dns server. We are going to create a local _zone_ called `canguro.zone`. For example our server will be accessible through `cangurosge.canguro.zone` and a sample cliente will be accessible through `canguros123.canguro.zone`.

### Server

First we need to install the required packages by typing.

```bash
sudo yum install bind bind-utils
```

Now we will create a key for our clients to update their addresses in the dns. 

```bash
dnssec-keygen -a HMAC-MD5 -b 512 -n USER canguro.zone.
```

This will generate two files with names that look like 

```
Kcanguro.zone.+157+51007.key 
Kcanguro.zone.+157+51007.private
```

We will put this files inside our nfs folder so that the clients can access them. Open the `.private` file and copy the long string after `key`. This string will have to be inserted in the `/etc/named.conf` file. We will need to add several other stuff to this file. Lets look at how it will look at the end.

```bash
#/etc/named.conf
//
// named.conf
//
// Provided by Red Hat bind package to configure the ISC BIND named(8) DNS
// server as a caching only nameserver (as a localhost DNS resolver only).
//
// See /usr/share/doc/bind*/sample/ for example named configuration files.
//

options {
		// Listen on the client ip address
        listen-on port 53 { 127.0.0.1 ; 10.0.2.5; }; 
        listen-on-v6 port 53 { ::1; };
        directory       "/var/named";
        dump-file       "/var/named/data/cache_dump.db";
        statistics-file "/var/named/data/named_stats.txt";
        memstatistics-file "/var/named/data/named_mem_stats.txt";
		// Allow queries only from our private network
        allow-query     { localhost; 10.0.2.1/24; };

        /*
		Comment stripped for brevity
        */
		
        recursion no;

        dnssec-enable yes;
        dnssec-validation yes;
        dnssec-lookaside auto;

        /* Path to ISC DLV key */
        bindkeys-file "/etc/named.iscdlv.key";

        managed-keys-directory "/var/named/dynamic";

        pid-file "/run/named/named.pid";
        session-keyfile "/run/named/session.key";
};

logging {
        channel default_debug {
                file "data/named.run";
                severity dynamic;
        };
};

zone "." IN {
        type hint;
        file "named.ca";
};

key canguro.zone.{
        algorithm "HMAC-MD5";
		// Copy it from the private key file
        secret "";
};

zone "canguro.zone" IN {
        type master;
        file "slaves/canguro.zone";
        allow-update {
                key canguro.zone;
                        };
        notify no;
};

// Inverted ip address from our private network
zone "2.0.10.in-addr.arpa." IN {
        type master;
        file "slaves/canguro.rr.zone";
        allow-update {
                key canguro.zone;
                        };
        notify no;
};

include "/etc/named.rfc1912.zones";
include "/etc/named.root.key";
```

Pay attention to the *allow-query* field, and the *key* block. The `zone "canguro.zone"` block is where we define forward dns, and is further specified in the file "slaves/canguro.zone"; we will create this file in the following step. The `zone "2.0.10.in-addr.arpa."` block is for reverse dns lookup. This block is very tricky and you need to pay special attention to the fact that *ip addresses are inverted*. For example `10.20.30.40` will look like `40.30.20.10`. Now lets look at the `zone` files

```bash
#/var/named/slaves/canguro.zone
$ORIGIN .
$TTL 7200       ; 2 hours
canguro.zone            IN SOA  ns0.canguro.zone. hostmaster.canguro.zone. (
                                2000640    ; serial
                                28800      ; refresh (8 hours)
                                1800       ; retry (30 minutes)
                                604800     ; expire (1 week)
                                86400      ; minimum (1 day)
                                )
                        NS      ns0.canguro.zone.
$ORIGIN canguro.zone.
$TTL 14000      ; 3 hours 53 minutes 20 seconds
ns0                     A       10.0.2.5
```

```bash
#/var/named/slaves/canguro.rr.zone
$ORIGIN .
$TTL 7200       ; 2 hours
2.0.10.in-addr.arpa IN SOA ns0.canguro.zone. hostmaster.canguro.zone. (
                                2000027    ; serial
                                28800      ; refresh (8 hours)
                                1800       ; retry (30 minutes)
                                604800     ; expire (1 week)
                                86400      ; minimum (1 day)
                                )
                        NS      ns0.canguro.zone.
                        PTR     ns0.canguro.zone.
$ORIGIN 2.0.10.in-addr.arpa.
```

Both of these files will get larger as clients begin to add their information. Now finally we need to start the service

```bash
systemctl start named.service
systemctl enable named.service
```

If something fails, run `systemctl status named` to look for a more useful error message. More detailed information can be found [here][bind_guide].

### Client

Now we are going to configure the clients to use our dns server. The easiest way of doing this is by changing the `/etc/resolv.conf` file, however notices this file will be overwritten by the dhcp client. In unacloud ip addresses are static so we will not have this problem.


#/etc/resolv.conf
```bash
domain canguro.zone
search canguro.zone
nameserver 10.0.2.5
nameserver 8.8.8.8
```

The first two lines let us do `ping cangurosge` instead of `ping cangurosge.canguro.zone`. The first nameserver is our own, but this server only resolves names inside canguro.zone. We use a second nameserver (in this example google) so that we can resolve standard domain names. For more information about this look [here][debian_dns].

Finally we need to register the clients with the nameserver. For that we need to `cd` into the directory containing the keys and use the ``nsupdate` application. We can do this by running the following script.

```bash
#update_dns.sh

#!/bin/bash
cd /home/canguro/nfs/keys
MYIP=$(hostname -I)
REVERSIP=$(echo $MYIP |awk -F"." '{for(i=NF;i>0;i--) printf i!=1?$i".":"%s",$i}')
MYNAME=$(hostname)
nsupdate -k Kcanguro.zone.+157+51007.private << EOF
server 10.0.2.5
update delete $MYNAME.canguro.zone A
update add $MYNAME.canguro.zone 14000 A $MYIP
send
update add $REVERSIP.in-addr.arpa 14000 PTR $MYNAME.canguro.zone
send
EOF
```

## Bibliography


[wiki_nfs]: http://fedoraproject.org/wiki/Administration_Guide_Draft/NFS
[debian_nfs]: https://www.linode.com/docs/networking/basic-nfs-configuration-on-debian-7
[bind_guide]: http://openshift.github.io/documentation/oo_notes_running_a_local_ddns.html
[debian_dns]: https://wiki.debian.org/NetworkConfiguration#Defining_the_.28DNS.29_Nameservers